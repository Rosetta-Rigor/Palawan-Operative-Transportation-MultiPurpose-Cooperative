{% extends 'base_no_sidebar.html' %}
{% load static %}
{% load tz %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_payments.css' %}">
<link rel="stylesheet" href="{% static 'css/payment_logs.css' %}">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
{% endblock %}

{% block title %}Car Wash Records - {{ year.year }}{% endblock %}

{% block content %}
<div class="content admin-dashboard">
  <div class="payments-container">
    
    <!-- Page Header -->
    <div class="payment-year-card">
      <br><br><br>
      <div class="payment-year-header">
        <h2 class="payment-year-title">
          <i class="las la-car-wash"></i> Car Wash Records - {{ year.year }}
        </h2>
        <p class="payment-year-subtitle">Track car wash compliance and service records</p>
      </div>
    </div>

    <div class="payment-actions-bar">
      <div class="payment-actions-left">
        <a href="{% url 'payment_year_list' %}" class="payment-action-btn btn-filter">
          <i class="las la-arrow-left"></i> Back to Years
        </a>
      </div>

      <div class="payment-actions-right">
        <a href="{% url 'add_carwash_type' year.id %}" class="payment-action-btn btn-filter">
          <i class="las la-spray-can"></i> Add Service Type
        </a>
        <a href="{% url 'manage_carwash_compliance' year.id %}" class="payment-action-btn btn-filter">
          <i class="las la-cog"></i> Settings
        </a>
        <a href="{% url 'carwash_public_records' year.id %}" class="payment-action-btn btn-filter">
          <i class="las la-user-friends"></i> Public Records {% if public_customer_records %}({{ public_customer_records.count }}){% endif %}
        </a>
      </div>
    </div>

    {% if not carwash_types %}
      <!-- Empty State: No Car Wash Service Types Configured -->
      <div class="payment-empty-state">
        <i class="las la-car-wash"></i>
        <h3>No Car Wash Service Types Configured</h3>
        <p>You need to create car wash service types (e.g., Basic, Premium, Deluxe) before you can track records.</p>
        <div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
          <a href="{% url 'manage_carwash_compliance' year.id %}" class="payment-action-btn btn-filter">
            <i class="las la-cog"></i> Configure Settings
          </a>
          <a href="{% url 'add_carwash_type' year.id %}" class="payment-action-btn btn-add">
            <i class="las la-plus"></i> Add Service Type
          </a>
        </div>
      </div>
    {% else %}
      
      <!-- Service Type Breakdown Card -->
      <div class="payment-type-card">
        <div class="payment-type-header">
          <h3 class="payment-type-name">
            <i class="las la-chart-bar"></i> Service Type Breakdown
          </h3>
        </div>
        
        {% if service_type_breakdown %}
        <div class="table-responsive">
          <table class="table table-sm" style="margin-bottom: 0;">
            <thead>
              <tr>
                <th class="table-sm th">Service Type</th>
                <th class="table-sm th" style="text-align: center;">Member Count</th>
                <th class="table-sm th" style="text-align: center;">Public Count</th>
                <th class="table-sm th" style="text-align: center;">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for service in service_type_breakdown %}
              <tr>
                <td class="table-sm td"><strong>{{ service.name }}</strong></td>
                <td class="table-sm td" style="text-align: center;">{{ service.member_count }}</td>
                <td class="table-sm td" style="text-align: center;">{{ service.public_count }}</td>
                <td class="table-sm td" style="text-align: center;"><strong style="color: var(--brand-600);">{{ service.total_count }}</strong></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p style="color: var(--muted-2); text-align: center; padding: 20px; margin: 0;">No service records available yet.</p>
        {% endif %}
      </div>

      {% if members_carwash_data %}
        <!-- Member Car Wash Records Table -->
        <div class="payment-table-container">
          <div class="payment-table-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h4 class="payment-table-title" style="margin: 0;">
              <i class="las la-users"></i> Member Car Wash Records
              <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.9; margin-left: 12px;">
                {% if compliance %}
                  (Required: {{ compliance.monthly_threshold }} washes/month)
                {% else %}
                  (No compliance threshold set)
                {% endif %}
              </span>
            </h4>
            <a href="{% url 'add_carwash_record' year.id %}" class="payment-action-btn btn-add" style="font-size: 0.9rem; padding: 10px 20px;">
              <i class="las la-plus"></i> Log Car Wash
            </a>
          </div>
          
          <!-- Search Box -->
          <div style="padding: 20px 28px; background: #f9f9f9; border-bottom: 1px solid #e0e0e0;">
            <div class="search-input-wrapper">
              <input 
                type="text" 
                id="memberSearchInput" 
                placeholder="Search by member name or vehicle plate number..."
                autocomplete="off"
              >
              <i class="las la-search"></i>
            </div>
          </div>
          
          <div class="search-loading" id="searchLoading">
            <i class="las la-spinner la-spin"></i> Searching...
          </div>
          
          <div class="search-no-results" id="searchNoResults">
            <i class="las la-search"></i>
            <h4>No members found</h4>
            <p>Try adjusting your search terms.</p>
          </div>
          
          <div class="table-responsive" id="carwashTableWrapper">
            <table class="payment-table" id="carwashTable">
              <thead>
                <tr>
                  <th style="min-width: 200px;">Member</th>
                  <th style="min-width: 150px;">Vehicles</th>
                  {% for month in months %}
                  <th style="text-align: center;">{{ month }}</th>
                  {% endfor %}
                  <th style="text-align: center;">Total</th>
                </tr>
              </thead>
              <tbody id="carwashTableBody">
                {% for data in page_obj %}
                <tr data-member-name="{{ data.member.full_name|lower }}" data-vehicle-plates="{% for vehicle in data.vehicles %}{{ vehicle.plate_number|lower }}{% if not forloop.last %} {% endif %}{% endfor %}">
                  <td><strong>{{ data.member.full_name }}</strong></td>
                  <td>
                    {% for vehicle in data.vehicles %}
                      <span class="vehicle-badge">
                        <i class="las la-car"></i> {{ vehicle.plate_number }}
                      </span>
                    {% endfor %}
                  </td>
                  {% for count in data.monthly_counts %}
                  <td style="text-align: center;" class="{% if compliance and count < compliance.monthly_threshold %}non-compliant-month{% endif %}">
                    {% if count > 0 %}
                      <span class="count-badge">{{ count }}</span>
                    {% else %}
                      <span class="count-zero">-</span>
                    {% endif %}
                  </td>
                  {% endfor %}
                  <td style="text-align: center;">
                    <strong style="color: var(--brand-600); font-size: 1.05rem;">{{ data.total_count }}</strong>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          {% if is_paginated %}
          <div style="padding: 20px; background: #f9f9f9; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div style="color: var(--muted-2); font-size: 0.95rem;">
              Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} members
            </div>
            
            <nav>
              <ul class="pagination" style="display: flex; gap: 8px; margin: 0; padding: 0; list-style: none;">
                {% if page_obj.has_previous %}
                <li>
                  <a href="?page=1" class="payment-action-btn btn-filter small" style="text-decoration: none;">
                    <i class="las la-angle-double-left"></i>
                  </a>
                </li>
                <li>
                  <a href="?page={{ page_obj.previous_page_number }}" class="payment-action-btn btn-filter small" style="text-decoration: none;">
                    <i class="las la-angle-left"></i> Previous
                  </a>
                </li>
                {% endif %}
                
                <li>
                  <span class="payment-action-btn small" style="background: var(--brand-600); color: white; cursor: default;">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                  </span>
                </li>
                
                {% if page_obj.has_next %}
                <li>
                  <a href="?page={{ page_obj.next_page_number }}" class="payment-action-btn btn-filter small" style="text-decoration: none;">
                    Next <i class="las la-angle-right"></i>
                  </a>
                </li>
                <li>
                  <a href="?page={{ page_obj.paginator.num_pages }}" class="payment-action-btn btn-filter small" style="text-decoration: none;">
                    <i class="las la-angle-double-right"></i>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
          {% endif %}
        </div>

      {% else %}
        <!-- Empty State: No Members with Vehicles -->
        <div class="payment-empty-state">
          <i class="las la-users-slash"></i>
          <h3>No Members with Vehicles</h3>
          <p>There are no members with registered vehicles to track car wash records.</p>
          <p style="margin-top: 10px; color: var(--muted-2);">
            <i class="las la-info-circle"></i> You can still log public customer records.
          </p>
        </div>
      {% endif %}
      
      <!-- Recent Car Wash Logs Section -->
      {% if recent_carwash_logs %}
      <div class="payment-table-container" style="margin-top: 30px;">
        <div class="payment-table-header">
          <h4 class="payment-table-title">
            <i class="las la-history"></i> Recent Car Wash Logs
            <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.9; margin-left: 12px;">
              (Last 5 services for {{ year.year }})
            </span>
          </h4>
        </div>
        
        <div class="table-responsive">
          <table class="payment-table">
            <thead>
              <tr>
                <th>Transaction ID</th>
                <th>Customer</th>
                <th>Vehicle</th>
                <th>Service</th>
                <th>Timestamp</th>
                <th>Logged By</th>
              </tr>
            </thead>
            <tbody>
              {% for log in recent_carwash_logs %}
              <tr>
                <td>
                  <span style="font-family: 'Courier New', monospace; font-weight: 600; color: var(--brand-600); font-size: 0.9rem;">
                    {{ log.transaction_id }}
                  </span>
                </td>
                <td>
                  <strong>{{ log.get_display_name }}</strong>
                  {% if log.customer_type == 'member' %}
                    <span class="member-badge" style="margin-left: 8px;">Member</span>
                  {% else %}
                    <span class="public-badge" style="margin-left: 8px;">Public</span>
                  {% endif %}
                  {% if log.member %}
                  <br><small style="color: var(--text-muted);">{{ log.member.batch }} | #{{ log.member.batch_monitoring_number }}</small>
                  {% endif %}
                </td>
                <td>
                  {% if log.vehicle %}
                    <strong>{{ log.vehicle.plate_number }}</strong>
                    <br><small style="color: var(--text-muted);">{{ log.vehicle.make_brand }}</small>
                  {% else %}
                    <span style="color: var(--text-muted);">{{ log.vehicle_plate|default:"N/A" }}</span>
                  {% endif %}
                </td>
                <td>
                  {{ log.service_type_name }}
                  {% if log.service_amount == 0 %}
                    <br><span class="carwash-info-badge" style="background: #4CAF50; font-size: 0.75rem;">Free</span>
                  {% else %}
                    <br><strong style="font-family: 'Courier New', monospace; color: var(--success); font-size: 0.95rem;">â‚±{{ log.service_amount|floatformat:2 }}</strong>
                  {% endif %}
                </td>
                <td style="font-size: 0.9rem;">
                  {{ log.timestamp|timezone:"Asia/Manila"|date:"M d, Y" }}<br>
                  <small style="color: var(--text-muted);">{{ log.timestamp|timezone:"Asia/Manila"|date:"h:i A" }}</small>
                </td>
                <td style="color: var(--text-muted); font-size: 0.9rem;">
                  {{ log.logged_by.username|default:"System" }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <div style="padding: 20px; text-align: center; background: #f9f9f9; border-top: 1px solid #e0e0e0;">
          <a href="{% url 'carwash_logs' %}?carwash_year={{ year.year }}" class="payment-action-btn btn-filter" style="font-size: 1rem; padding: 12px 24px;">
            <i class="las la-list"></i> View All Car Wash Logs for {{ year.year }}
          </a>
        </div>
      </div>
      {% endif %}
      
    {% endif %}

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('memberSearchInput');
    const tableBody = document.getElementById('carwashTableBody');
    const tableWrapper = document.getElementById('carwashTableWrapper');
    const searchLoading = document.getElementById('searchLoading');
    const searchNoResults = document.getElementById('searchNoResults');
    const paginationDiv = document.querySelector('.pagination')?.closest('div').parentElement;
    
    if (!searchInput || !tableBody) return;
    
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const searchTerm = this.value.toLowerCase().trim();
        
        // Show loading state
        if (searchTerm.length > 0) {
            searchLoading.style.display = 'block';
            tableWrapper.style.opacity = '0.5';
        }
        
        searchTimeout = setTimeout(function() {
            if (searchTerm.length === 0) {
                // Show all rows
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(row => row.style.display = '');
                tableWrapper.style.opacity = '1';
                searchLoading.style.display = 'none';
                searchNoResults.style.display = 'none';
                if (paginationDiv) paginationDiv.style.display = 'flex';
                return;
            }
            
            // Filter rows
            const rows = tableBody.querySelectorAll('tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const memberName = row.getAttribute('data-member-name') || '';
                const vehiclePlates = row.getAttribute('data-vehicle-plates') || '';
                
                if (memberName.includes(searchTerm) || vehiclePlates.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Show/hide no results message
            tableWrapper.style.opacity = '1';
            searchLoading.style.display = 'none';
            
            if (visibleCount === 0) {
                tableWrapper.style.display = 'none';
                searchNoResults.style.display = 'block';
            } else {
                tableWrapper.style.display = 'block';
                searchNoResults.style.display = 'none';
            }
            
            // Hide pagination when searching
            if (paginationDiv) {
                paginationDiv.style.display = searchTerm.length > 0 ? 'none' : 'flex';
            }
        }, 300); // Debounce for 300ms
    });
    
    // Clear search on escape key
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.value = '';
            this.dispatchEvent(new Event('input'));
            this.blur();
        }
    });
});
</script>
{% endblock %}