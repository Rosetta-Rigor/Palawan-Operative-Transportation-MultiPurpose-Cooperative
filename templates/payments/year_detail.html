{% extends 'base_no_sidebar.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_payments.css' %}">
{% endblock %}

{% block title %}Payments for {{ year.year }}{% endblock %}

{% block content %}
<div class="content admin-dashboard">
  <div class="payments-container">
    <div class="payment-year-card">
          <br><br><br>
      <div class="payment-year-header">
        <h2 class="payment-year-title">
          <i class="las la-file-invoice-dollar"></i> Payments for {{ year.year }}
        </h2>
        <p class="payment-year-subtitle">Overview of all payment records</p>
      </div>
    </div>

    <div class="payment-actions-bar">
      <div class="payment-actions-left">
        <a href="{% url 'payment_year_list' %}" class="payment-action-btn btn-filter">
          <i class="las la-arrow-left"></i> Back to Years
        </a>
        <a href="{% url 'from_members_payment_view' year.id %}" class="payment-action-btn btn-filter">
          <i class="las la-users"></i> From Members
        </a>
        <a href="{% url 'other_payments_view' year.id %}" class="payment-action-btn btn-filter">
          <i class="las la-file-alt"></i> Other Payments
        </a>
      </div>
      <div class="payment-actions-right">
        <div class="dropdown" style="display: inline-block;">
          <button class="payment-action-btn btn-export dropdown-toggle" type="button" id="exportDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="las la-file-pdf"></i> Export PDF
          </button>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="exportDropdown">
            <a class="dropdown-item" href="{% url 'export_year_pdf' year.id 'all' %}">
              <i class="las la-file-invoice"></i> All Payments
            </a>
            <a class="dropdown-item" href="{% url 'export_year_pdf' year.id 'from_members' %}">
              <i class="las la-users"></i> From Members Only
            </a>
            <a class="dropdown-item" href="{% url 'export_year_pdf' year.id 'others' %}">
              <i class="las la-file-alt"></i> Others Only
            </a>
          </div>
        </div>
        <a href="{% url 'add_payment_type' year.id %}" class="payment-action-btn btn-add">
          <i class="las la-plus"></i> Add Payment Type
        </a>
      </div>
    </div>

  <div class="payment-table-container">
    <div class="payment-table-header">
      <h4 class="payment-table-title">
        <i class="las la-table"></i> Payment Summary
      </h4>
    </div>
    <div class="table-responsive">
      <table class="payment-table">
    <thead>
      <tr>
        <th>Payment Type</th>
        {% for month in months %}
          <th class="text-right">{{ month }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% if from_members_data %}
        <!-- From Members Section -->
        <tr style="background: linear-gradient(180deg, #F6F4ED, #FFFFFF); border-top: 3px solid var(--brand-600);">
          <td colspan="13" style="font-weight: 800; color: var(--brand-600); font-size: 1rem; padding: 16px 20px; text-transform: uppercase; letter-spacing: 0.5px;">
            <i class="las la-users"></i> FROM MEMBERS
          </td>
        </tr>
        {% for data in from_members_data %}
          <tr>
            <td style="font-weight: 700; color: var(--brand-600);">
              {{ data.payment_type.name }}
              {% if data.is_car_wash %}
                <span class="carwash-info-badge" style="margin-left: 8px;">Counts</span>
              {% endif %}
            </td>
            {% for total in data.monthly_totals %}
              <td class="text-right amount-cell">
                {% if data.is_car_wash %}
                  <!-- Display COUNT for car wash -->
                  {% if total %}
                    <span class="count-badge">{{ total }}</span>
                  {% else %}
                    -
                  {% endif %}
                {% else %}
                  <!-- Display AMOUNT for regular payments -->
                  {{ total|default:"-" }}
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      {% endif %}

      {% if other_data %}
        <!-- Other Payments Section -->
        <tr style="background: linear-gradient(180deg, #F6F4ED, #FFFFFF); border-top: 3px solid var(--accent-500);">
          <td colspan="13" style="font-weight: 800; color: var(--accent-500); font-size: 1rem; padding: 16px 20px; text-transform: uppercase; letter-spacing: 0.5px;">
            <i class="las la-file-alt"></i> OTHER PAYMENTS
          </td>
        </tr>
        {% for data in other_data %}
          <tr>
            <td style="font-weight: 700; color: var(--brand-600);">{{ data.payment_type.name }}</td>
            {% for total in data.monthly_totals %}
              <td class="text-right amount-cell">{{ total|default:"-" }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      {% endif %}

      {% if not from_members_data and not other_data %}
        <tr>
          <td colspan="13" class="text-center" style="padding: 40px 20px; color: var(--muted-2);">
            <div style="font-size: 2.5rem; opacity: 0.3; margin-bottom: 12px;">
              <i class="las la-file-invoice"></i>
            </div>
            <strong>No payment types found.</strong><br>
            <small>Create your first payment type to start tracking.</small>
          </td>
        </tr>
      {% endif %}
    </tbody>
      </table>
    </div>
  </div>
  
  <!-- Recent Payment Logs Section -->
  {% if recent_payment_logs %}
  <div class="payment-table-container" style="margin-top: 30px;">
    <div class="payment-table-header" style="background: linear-gradient(135deg, #C99E35, #B8922F);">
      <h4 class="payment-table-title">
        <i class="las la-history"></i> Recent Payment Logs
      </h4>
      <small style="color: rgba(255,255,255,0.9);">
        <i class="las la-info-circle"></i> Last 5 payment transactions for {{ year.year }}
      </small>
    </div>
    <div class="table-responsive">
      <table class="payment-table">
        <thead>
          <tr>
            <th>Transaction ID</th>
            <th>Date & Time</th>
            <th>Category</th>
            <th>Member/Payee</th>
            <th>Payment Type</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Logged By</th>
          </tr>
        </thead>
        <tbody>
          {% for log in recent_payment_logs %}
          <tr>
            <td>
              <span style="font-family: 'Courier New', monospace; font-weight: 600; color: var(--brand-600); font-size: 0.9rem;">
                {{ log.transaction_id }}
              </span>
            </td>
            <td style="font-size: 0.9rem;">{{ log.timestamp|date:"M d, Y H:i" }}</td>
            <td>
              {% if log.category == 'from_members' %}
              <span class="carwash-info-badge" style="background: var(--brand-600);">
                <i class="las la-users"></i> From Members
              </span>
              {% else %}
              <span class="carwash-info-badge" style="background: var(--accent-500);">
                <i class="las la-file-alt"></i> Other
              </span>
              {% endif %}
            </td>
            <td>
              <strong>{{ log.get_display_name }}</strong>
              {% if log.member %}
              <br><small style="color: var(--text-muted);">{{ log.member.batch }} | #{{ log.member.batch_monitoring_number }}</small>
              {% endif %}
            </td>
            <td>{{ log.payment_type_name }}</td>
            <td>
              <strong style="font-family: 'Courier New', monospace; color: #228B22; font-size: 1.05rem;">
                â‚±{{ log.amount|floatformat:2 }}
              </strong>
            </td>
            <td>
              {% if log.status == 'confirmed' %}
              <span class="carwash-info-badge" style="background: #4CAF50;">
                <i class="las la-check-circle"></i> Confirmed
              </span>
              {% elif log.status == 'pending' %}
              <span class="carwash-info-badge" style="background: #FF9800;">
                <i class="las la-clock"></i> Pending
              </span>
              {% else %}
              <span class="carwash-info-badge" style="background: #f44336;">
                <i class="las la-times-circle"></i> Reversed
              </span>
              {% endif %}
            </td>
            <td style="color: var(--text-muted); font-size: 0.9rem;">
              {{ log.logged_by.username|default:"System" }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div style="padding: 20px; text-align: center; background: #f9f9f9; border-top: 1px solid #e0e0e0;">
      <a href="{% url 'payment_logs' %}?payment_year={{ year.year }}" class="payment-action-btn btn-filter" style="font-size: 1rem; padding: 12px 24px;">
        <i class="las la-list"></i> View All Payment Logs for {{ year.year }}
      </a>
    </div>
  </div>
  {% endif %}
  
  </div>
</div>
{% endblock %}