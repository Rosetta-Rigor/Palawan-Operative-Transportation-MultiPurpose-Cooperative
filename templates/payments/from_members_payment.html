{% extends 'base_no_sidebar.html' %}
{% load static %}

{% block title %}From Members Payments - {{ year.year }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_payments.css' %}">
{% endblock %}

{% block content %}
<div class="content admin-dashboard full-width-content">
  <div class="payments-container">
    <div class="payment-year-card">
      <br><br><br>
      <div class="payment-year-header">
        <h3 class="payment-year-title">From Members Payments - {{ year.year }}</h3>
        <p class="payment-year-subtitle">Track member payment balances across all payment types</p>
      </div>
    </div>

    <div class="payment-actions-bar">
      <div class="payment-actions-left">
        <a href="{% url 'payment_year_detail' year.id %}" class="payment-action-btn btn-filter">
          <i class="las la-arrow-left"></i> Back to Year Detail
        </a>
      </div>
      <div class="payment-actions-right">
        <a href="{% url 'add_payment_entry' year.id %}" class="payment-action-btn btn-add">
          <i class="las la-plus"></i> Add Payment
        </a>
      </div>
    </div>

    <!-- Member Search Filter -->
    <div class="payment-member-search">
      <label for="member-search">
        <i class="las la-search"></i> Search Member
      </label>
      <input type="text" id="member-search" class="form-control" placeholder="Type member name or batch...">
    </div>

    <!-- Payment List Table -->
    <div class="payment-table-container">
      <div class="payment-table-header">
        <h4><i class="las la-file-invoice-dollar"></i> Member Payment Summary</h4>
        <small id="search-results-count" class="text-muted"></small>
      </div>
      <div class="table-responsive">
        <table class="payment-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Member Name</th>
              <th>Batch</th>
              {% for payment_type in payment_types %}
                <th class="text-right">
                  {{ payment_type.name }}
                  {% if payment_type.is_car_wash %}
                    <br><small class="text-muted" style="font-weight: normal; font-size: 0.75rem;">Car Wash</small>
                  {% endif %}
                </th>
              {% endfor %}
            </tr>
          </thead>
          <tbody id="payment-table-body">
            {% for member in members %}
              <tr class="clickable-row" data-url="{% url 'member_payment_list' year.id member.id %}" data-member-name="{{ member.full_name|lower }}" data-batch="{{ member.batch|lower }}">
                <td class="row-number">{{ forloop.counter }}</td>
                <td><strong>{{ member.full_name }}</strong></td>
                <td>{{ member.batch }}</td>
                {% for pt_data in member.payment_types_data %}
                  <td class="amount-cell text-right">
                    {% if pt_data.is_car_wash %}
                      {% if pt_data.total_count > 0 %}
                        {{ pt_data.total_count }}
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    {% else %}
                      {% if pt_data.total_paid > 0 %}
                        â‚±{{ pt_data.total_paid|floatformat:2 }}
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% empty %}
              <tr id="empty-state-row">
                <td colspan="{{ payment_types|length|add:3 }}" class="text-center">
                  <div class="payment-empty-state">
                    <i class="las la-inbox"></i>
                    <p>No member payment records yet</p>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <div id="no-results-message" style="display: none; text-align: center; padding: 40px;">
          <i class="las la-search" style="font-size: 3rem; color: #ccc;"></i>
          <p style="color: #666; margin-top: 10px;">No members found matching your search.</p>
        </div>
      </div>
    </div>
    
    {% if not payment_types %}
    <div class="alert alert-info">
      <i class="las la-info-circle"></i>
      No "From Members" payment types configured for {{ year.year }}. Please add payment types first.
    </div>
    {% endif %}

    {% include 'includes/pagination.html' %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
  // Client-side search functionality
  $('#member-search').on('input', function() {
    const searchTerm = $(this).val().toLowerCase().trim();
    const $tableBody = $('#payment-table-body');
    const $rows = $tableBody.find('tr.clickable-row');
    const $emptyStateRow = $('#empty-state-row');
    const $noResultsMessage = $('#no-results-message');
    const $resultsCount = $('#search-results-count');
    
    let visibleCount = 0;
    
    // If search is empty, show all rows
    if (searchTerm === '') {
      $rows.show();
      $noResultsMessage.hide();
      $resultsCount.text('');
      
      // Update row numbers
      $rows.each(function(index) {
        $(this).find('.row-number').text(index + 1);
      });
      return;
    }
    
    // Filter rows based on search term
    $rows.each(function() {
      const $row = $(this);
      const memberName = $row.data('member-name') || '';
      const batch = $row.data('batch') || '';
      
      // Check if search term matches member name or batch
      if (memberName.includes(searchTerm) || batch.includes(searchTerm)) {
        $row.show();
        visibleCount++;
        // Update row number
        $row.find('.row-number').text(visibleCount);
      } else {
        $row.hide();
      }
    });
    
    // Show/hide no results message
    if (visibleCount === 0) {
      $noResultsMessage.show();
      $emptyStateRow.hide();
      $resultsCount.text('No matches found');
    } else {
      $noResultsMessage.hide();
      $resultsCount.text(`Showing ${visibleCount} member${visibleCount !== 1 ? 's' : ''}`);
    }
  });

  // Make table rows clickable
  $(document).on('click', '.clickable-row', function(e) {
    // Prevent navigation if clicking on a link or button
    if ($(e.target).closest('a, button').length === 0) {
      window.location.href = $(this).data('url');
    }
  });

  // Add hover effect hint
  $('.clickable-row').attr('title', 'Click to view detailed payment records');
  
  // Focus search input on page load
  $('#member-search').focus();
});
</script>
{% endblock %}