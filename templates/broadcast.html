{% extends 'base.html' %}
{% load static %}
{% block title %}Broadcast Announcements{% endblock %}

{% block content %}
<div class="content admin-dashboard">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="page-header-section">
            <div class="d-flex align-items-center justify-content-between flex-wrap mb-3">
                <div class="d-flex align-items-center gap-3">
                    <a href="{% url 'home' %}" class="back-btn" title="Back to Dashboard">
                        <i class="las la-arrow-left"></i>
                    </a>
                    <div>
                        <h1 class="page-title mb-1">
                            <i class="las la-bullhorn"></i>
                            Broadcast Announcements
                        </h1>
                        <p class="page-subtitle mb-0">
                            Send notifications and announcements to members
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column: Broadcast Form -->
            <div class="col-lg-5 col-md-6">
                <div class="admin-form-card broadcast-form-card">
                    <div class="form-header-gradient">
                        <h4 class="form-header-title">
                            <i class="las la-paper-plane"></i>
                            New Broadcast
                        </h4>
                        <p class="form-header-sub">Compose and send a message</p>
                    </div>
                    
                    <div class="form-content">
                        <form method="post" action="{% url 'broadcast' %}">
                            {% csrf_token %}
                            {{ form.non_field_errors }}
                            
                            <div class="form-group mb-3">
                                <label class="broadcast-label">
                                    <i class="las la-comment-dots"></i> Message
                                </label>
                                {{ form.message }}
                                {% if form.message.errors %}
                                    <div class="text-danger small mt-2">{{ form.message.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="form-group mb-4">
                                <label class="broadcast-label">
                                    <i class="las la-users"></i> Recipients
                                </label>
                                {{ form.recipients }}
                                <small class="form-text text-muted d-block mt-2">
                                    <i class="las la-info-circle"></i> {{ form.recipients.help_text }}
                                </small>
                                {% if form.recipients.errors %}
                                    <div class="text-danger small mt-2">{{ form.recipients.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="broadcast-actions">
                                <button type="submit" class="btn btn-broadcast-send">
                                    <i class="las la-paper-plane"></i> Send Broadcast
                                </button>
                                <a href="{% url 'home' %}" class="btn btn-broadcast-cancel">
                                    <i class="las la-times"></i> Cancel
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Right Column: Recent Broadcasts -->
            <div class="col-lg-7 col-md-6">
                <div class="admin-form-card broadcast-history-card">
                    <div class="form-header-gradient">
                        <h4 class="form-header-title">
                            <i class="las la-history"></i>
                            Recent Broadcasts
                        </h4>
                        <p class="form-header-sub">History of sent announcements</p>
                    </div>
                    
                    <div class="form-content">
                        <div class="broadcast-list">
                            {% for item in broadcasts %}
                                <div class="broadcast-item">
                                    <div class="broadcast-item-header">
                                        <div class="broadcast-author">
                                            <i class="las la-user-circle"></i>
                                            <strong>{{ item.created_by.get_username|default:"System" }}</strong>
                                        </div>
                                        <div class="broadcast-meta">
                                            <span class="broadcast-date">
                                                <i class="las la-clock"></i>
                                                {{ item.created_at|date:"M d, Y H:i" }}
                                            </span>
                                            <span class="broadcast-recipients-badge">
                                                <i class="las la-users"></i>
                                                {% if item.recipients.exists %}
                                                    {{ item.recipients.count }} recipient{{ item.recipients.count|pluralize }}
                                                {% else %}
                                                    All Members
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="broadcast-message">
                                        {{ item.message }}
                                    </div>
                                </div>
                            {% empty %}
                                <div class="broadcast-empty">
                                    <i class="las la-inbox"></i>
                                    <p>No broadcasts sent yet</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // initialize Select2 for recipients if present
  try {
    const $rec = $('#id_recipients');
    if ($rec.length) {
      $rec.select2({
        theme: 'bootstrap-5',
        placeholder: 'Select client recipients (leave empty = all clients)',
        allowClear: true,
        width: '100%'
      });
    }
  } catch (e) {
    console.warn('Select2 init failed', e);
  }
});
</script>
{% endblock %}