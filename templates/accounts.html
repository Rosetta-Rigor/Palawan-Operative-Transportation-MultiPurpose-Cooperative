{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_all.css' %}">
{% endblock %}
{% block title %}Accounts List{% endblock %}
{% block content %}
<br><br>
<div class="container py-4">
  <div class="members-header card-header-gradient mb-4 d-flex justify-content-between align-items-center">
    <div>
      <h1 class="members-header-title">ACCOUNTS</h1>
      <p class="members-header-sub">Manage user accounts and linked member profiles</p>
    </div>
    <div class="d-flex align-items-center">
      <div class="btn-group">
        <a href="{% url 'member_list' %}" class="btn btn-primary">View Members</a>
      </div>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-8">
      <form id="account-search-form" action="{% url 'accounts_list' %}">
        <div class="search-card p-3 d-flex align-items-center">
          <input type="text" id="account-search" name="q" class="form-control form-control-lg search-input" placeholder="Search username, name, email..." autocomplete="off" value="{{ q|default:'' }}">
          <button type="button" class="btn btn-light ml-2" id="account-search-clear" title="Clear"><i class="la la-times"></i></button>
          <button type="submit" class="btn btn-primary ml-2"><i class="la la-search"></i></button>

          <!-- status filter -->
          <select id="account-status" name="status" class="form-control ml-3" style="width:180px;">
            <option value="all" {% if status == 'all' %}selected{% endif %}>All accounts</option>
            <option value="activated" {% if status == 'activated' %}selected{% endif %}>Active</option>
            <option value="pending" {% if status == 'pending' %}selected{% endif %}>Inactive</option>
          </select>
        </div>
      </form>
    </div>
  </div>

  <div class="card admin-card material-table">
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0 no-row-hover">
        <thead class="table-head">
          <tr>
            <th>Username</th>
            <th>Full Name</th>
            <th>Email</th>
            <th>Phone Number</th>
            <th>Role</th>
            <th>Connected Member</th>
            <th>ID Image</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="account-table-body" class="material-rows">
          {% include 'includes/account_table_rows.html' %}
        </tbody>
      </table>
    </div>
  </div>

  <div id="pagination-container" class="mt-3">
    {% include 'includes/pagination.html' %}
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function(){
  function debounce(fn, delay){ var t; return function(){ var ctx=this,args=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(ctx,args); }, delay); }; }

  function appendStatusToLinks(status) {
    if (!status) return;
    $('#pagination-container .pagination a.page-link').each(function(){
      var $a = $(this);
      var href = $a.attr('href') || '';
      if (!href) return;
      // if status already present, skip
      if (href.indexOf('status=') !== -1) return;
      var sep = href.indexOf('?') === -1 ? '?' : '&';
      $a.attr('href', href + sep + 'status=' + encodeURIComponent(status));
    });
  }

  function fetchAccounts(params){
    params = params || {};
    // ensure status param included
    if (!('status' in params)) params.status = $('#account-status').val() || 'all';
    $.ajax({
      url: "{% url 'accounts_list' %}",
      data: params,
      dataType: 'json',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      success: function(data){
        if (data.html !== undefined) $('#account-table-body').html(data.html);
        if (data.pagination_html !== undefined) {
          $('#pagination-container').html(data.pagination_html);
          // ensure pagination links preserve current status
          appendStatusToLinks(params.status);
        }
        // update URL querystring (lightweight)
        try {
          var url = new URL(window.location.href);
          url.searchParams.set('status', params.status || 'all');
          if (params.q) url.searchParams.set('q', params.q);
          else url.searchParams.delete('q');
          url.searchParams.delete('page');
          window.history.replaceState({}, '', url.toString());
        } catch (err) {}
      }
    });
  }

  var debounced = debounce(function(){ fetchAccounts({ q: $('#account-search').val(), status: $('#account-status').val() }); }, 300);
  $('#account-search').on('input', debounced);

  $('#account-search-clear').on('click', function(){
    $('#account-search').val('');
    fetchAccounts({ q: '', status: $('#account-status').val() });
  });

  $('#account-status').on('change', function(){
    // when status changes, fetch and reset to first page
    fetchAccounts({ q: $('#account-search').val(), status: $(this).val(), page: 1 });
  });

  // prefer full page refresh for pagination but ensure status preserved in links (server-side render may not include status)
  $(document).off('click.accountPagination');
  $(document).on('click.accountPagination', '#pagination-container .pagination a.page-link', function(){ /* allow default navigation */ });

  // initial append to existing links on page load
  appendStatusToLinks($('#account-status').val());
});
</script>
{% endblock %}