{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Login - POTMPC</title>
    <link rel="stylesheet" href="{% static 'css/login_custom.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
</head>
<body>
<div class="carousel-background">
    <img src="{% static 'img/bg.jpg' %}" class="carousel-img active" alt="Background 1">
    <img src="{% static 'img/bg2.jpg' %}" class="carousel-img" alt="Background 2">
    <img src="{% static 'img/bg3.jpg' %}" class="carousel-img" alt="Background 3">
    <img src="{% static 'img/bg4.jpg' %}" class="carousel-img" alt="Background 4">
</div>
<div class="overlay"></div>

<div class="auth-card qr-scanner-card">
    <a href="{% url 'login' %}" class="back-btn" title="Back to Login">
        <span>&#8592;</span>
    </a>
    
    <div class="auth-header">
        <img src="{% static 'img/home.png' %}" class="auth-logo" onerror="this.style.display='none'">
        <h1 class="auth-title">QR Code Login</h1>
        <p class="auth-subtitle">Scan your QR code to sign in</p>
    </div>
    <div class="qr-scanner-section">
        <button id="start-scan-btn" type="button" class="auth-btn qr-btn">
            <span class="method-icon">&#128247;</span>
            Open Camera
        </button>
        <button id="stop-scan-btn" type="button" class="auth-btn" style="display:none; background: var(--danger);">
            Stop Scanner
        </button>
        
        <div id="qr-reader" style="margin-top:20px;">
            <video id="qr-video" width="400" height="300" autoplay playsinline style="border-radius:12px; display:none; max-width:100%;"></video>
            <canvas id="qr-canvas" width="400" height="300" style="display:none;"></canvas>
            <div id="qr-result" style="margin-top:12px; color: var(--muted); font-weight:600;"></div>
        </div>
    </div>

    <div class="qr-divider">
        <span>OR</span>
    </div>

    <form method="post" enctype="multipart/form-data" action="{% url 'qr-image-login' %}" class="qr-upload-form">
        {% csrf_token %}
        <div class="form-group">
            <label for="qr_image">Upload QR Code Image</label>
            <div class="file-upload-wrapper">
                <input type="file" name="qr_image" id="qr_image" accept="image/*" required>
                <label for="qr_image" class="file-upload-label">
                    <span class="file-icon">&#128247;</span>
                    <span class="file-text">Choose QR Image</span>
                </label>
            </div>
        </div>
        <button type="submit" id="qr-login-btn" class="auth-btn" disabled>Login with QR Image</button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Carousel functionality
        const carouselImages = document.querySelectorAll('.carousel-img');
        let currentIndex = 0;

        function showNextImage() {
            carouselImages[currentIndex].classList.remove('active');
            currentIndex = (currentIndex + 1) % carouselImages.length;
            carouselImages[currentIndex].classList.add('active');
        }
        setInterval(showNextImage, 7000);

        // File upload handling
        const fileInput = document.getElementById("qr_image");
        const loginButton = document.getElementById("qr-login-btn");
        const fileLabel = document.querySelector('.file-upload-label .file-text');

        fileInput.addEventListener("change", function() {
            if (fileInput.files.length > 0) {
                loginButton.disabled = false;
                fileLabel.textContent = fileInput.files[0].name;
            } else {
                loginButton.disabled = true;
                fileLabel.textContent = 'Choose QR Image';
            }
        });
    });

    (function() {
  // DOM refs
  const startBtn = document.getElementById("start-scan-btn");
  const stopBtn = document.getElementById("stop-scan-btn");
  const video = document.getElementById("qr-video");
  const canvas = document.getElementById("qr-canvas");
  const qrResult = document.getElementById("qr-result");
  const ctx = canvas.getContext("2d");

  let stream = null;
  let detector = null;
  let processing = false;
  let scanning = false;
  let processInterval = null;

  // Wait until OpenCV is ready
  function onOpenCvReady(cb) {
    if (typeof cv !== "undefined" && cv && cv['QRCodeDetector']) {
      cb();
    } else {
      // poll for opencv load
      const t = setInterval(() => {
        if (typeof cv !== "undefined" && cv && cv['QRCodeDetector']) {
          clearInterval(t);
          cb();
        }
      }, 100);
    }
  }

  function startCamera() {
    return navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(s => {
        stream = s;
        video.srcObject = stream;
        video.style.display = "block";
        return video.play();
      });
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.pause();
    video.srcObject = null;
    video.style.display = "none";
  }

  function startProcessingFrames() {
    if (!detector) detector = new cv.QRCodeDetector();
    scanning = true;
    // process at an interval (approx ~10 fps); requestAnimationFrame would also work
    processInterval = setInterval(processFrame, 100);
  }

  function stopProcessingFrames() {
    scanning = false;
    if (processInterval) { clearInterval(processInterval); processInterval = null; }
  }

  function processFrame() {
    if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) return;
    try {
      // draw current video frame to canvas
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      // read canvas into OpenCV mat
      let src = cv.imread(canvas);
      // decode QR
      let points = new cv.Mat();
      let straight = new cv.Mat();
      // detectAndDecode returns a string (decoded text) in OpenCV.js
      let decoded = detector.detectAndDecode(src, points, straight);
      src.delete();
      points.delete();
      straight.delete();

      if (decoded && decoded.length > 0) {
        // found QR content
        qrResult.innerText = "QR detected: " + decoded;
        stopProcessingFrames();
        stopCamera();
        // redirect logic: if decoded contains http, go there; otherwise assume it's token
        if (decoded.startsWith("http://") || decoded.startsWith("https://")) {
          window.location.href = decoded;
        } else {
          // token only
          const token = encodeURIComponent(decoded.trim());
          window.location.href = "/qr-login/" + token + "/";
        }
      }
    } catch (err) {
      console.error("QR processing error:", err);
    }
  }

  // Start handler
  startBtn.addEventListener("click", () => {
    // Avoid double-start
    if (scanning) return;
    qrResult.innerText = "Starting camera...";
    // ensure we wait for OpenCV lib to be available
    onOpenCvReady(() => {
      startCamera().then(() => {
        qrResult.innerText = "Camera started. Point at QR...";
        startProcessingFrames();
        startBtn.style.display = "none";
        stopBtn.style.display = "inline-block";
      }).catch(err => {
        qrResult.innerText = "Camera error: " + err;
        console.error(err);
      });
    });
  });

  // Stop handler
  stopBtn.addEventListener("click", () => {
    stopProcessingFrames();
    stopCamera();
    startBtn.style.display = "inline-block";
    stopBtn.style.display = "none";
    qrResult.innerText = "";
  });

  // Ensure cleanup when navigating away or closing
  window.addEventListener("beforeunload", () => {
    stopProcessingFrames();
    stopCamera();
  });
})();
</script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
</body>
</html>