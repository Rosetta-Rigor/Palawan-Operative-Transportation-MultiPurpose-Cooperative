{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_all.css' %}">
<link rel="stylesheet" href="{% static 'css/admin_forms.css' %}">
{% endblock %}
{% block content %}
<div class="container py-4">
  <!-- Header with vehicle-themed background -->
  <div class="members-header card-header-gradient mb-4 d-flex justify-content-between align-items-center">
    <div>
      <h1 class="members-header-title">MEMBERS</h1>
      <p class="members-header-sub">Manage cooperative members and their vehicles</p>
    </div>
    <div class="d-flex align-items-center">
      <div class="btn-group">
        <a href="{% url 'member_add' %}" class="btn btn-success">Add Member</a>
        <a href="/batches/1/" class="btn btn-primary">View Batches</a>
      </div>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <form action="{% url 'member_list' %}">
        <div class="search-card p-3 d-flex align-items-center">
          <input type="text" id="member-search" name="q" class="form-control form-control-lg search-input" placeholder="Search members or plates..." autocomplete="off">
          <button type="button" class="btn btn-light ml-2" id="member-search-clear" title="Clear"><i class="la la-times"></i></button>
          <button type="submit" class="btn btn-primary ml-2"><i class="la la-search"></i></button>
        </div>
      </form>
    </div>
  </div>

  <div class="card admin-card material-table">
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0">
        <thead class="table-head">
          <tr>
            <th>#</th>
            <th>Full Name</th>
            <th>Batch</th>
            <th>Phone</th>
            <th>Email</th>
            <th>Vehicles</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="member-table-body" class="material-rows">
          {% include 'includes/member_table_rows.html' %}
        </tbody>
      </table>
    </div>
  </div>

  <div id="pagination-container" class="mt-3">
    {% include 'includes/pagination.html' %}
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function() {
  // Debounce helper
  function debounce(fn, delay) {
    var timer = null;
    return function() {
      var context = this, args = arguments;
      clearTimeout(timer);
      timer = setTimeout(function() {
        fn.apply(context, args);
      }, delay);
    };
  }

  function fetchMembers(params) {
    params = params || {};
    $.ajax({
      url: "{% url 'member_list' %}",
      data: params,
      dataType: 'json',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      success: function(data) {
        if (data.html !== undefined) {
          $('#member-table-body').html(data.html);
        }
        if (data.pagination_html !== undefined) {
          $('#pagination-container').html(data.pagination_html);
        }
        // rebind handlers after replacing HTML
        bindActionMenus();
      }
    });
  }

  var debouncedFetch = debounce(function() {
    fetchMembers({ q: $('#member-search').val() });
  }, 300);

  $('#member-search').on('input', debouncedFetch);

  // Clear button
  $('#member-search-clear').on('click', function() {
    $('#member-search').val('');
    fetchMembers({ q: '' });
  });

  
  $(document).off('click.memberPagination');

 
  $(document).on('click.memberPagination', '#pagination-container .pagination a.page-link', function(e){
   
  });

  // Action menu behavior (open upwards)
  function bindActionMenus() {
    $('.action-toggle').off('click').on('click', function(e){
      e.preventDefault();
      var $btn = $(this);
      var $container = $btn.closest('.action-container');
      var $menu = $container.find('.action-menu');
      // close others
      $('.action-menu').not($menu).removeClass('open').attr('aria-hidden','true');
      // toggle
      $menu.toggleClass('open');
      $menu.attr('aria-hidden', !$menu.hasClass('open'));
      // if opening, ensure it fits in viewport; if not, flip to open downward
      if ($menu.hasClass('open')) {
        var menuRect = $menu[0].getBoundingClientRect();
        if (menuRect.top < 8) {
          // flip: open down instead
          $menu.css({ bottom: 'auto', top: '44px' });
          $menu.find('::after'); // noop - CSS caret remains acceptable
        } else {
          $menu.css({ bottom: '44px', top: 'auto' });
        }
      } else {
        // reset inline style
        $menu.css({ bottom: '', top: '' });
      }
    });

    // close menus on outside click or ESC
    $(document).off('click.actionMenu').on('click.actionMenu', function(e){
      if (!$(e.target).closest('.action-container').length) {
        $('.action-menu.open').removeClass('open').attr('aria-hidden','true');
      }
    });
    $(document).off('keydown.actionMenu').on('keydown.actionMenu', function(e){
      if (e.key === 'Escape') $('.action-menu.open').removeClass('open').attr('aria-hidden','true');
    });
  }

  // bind on initial load
  bindActionMenus();
});
</script>
{% endblock %}