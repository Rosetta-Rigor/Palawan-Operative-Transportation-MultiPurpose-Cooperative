{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_all.css' %}">
{% endblock %}

{% block title %}Batch {{ batch.number }} — Members{% endblock %}

{% block content %}
<div class="admin-dashboard container py-5">
  <div class="row mb-3">
    <div class="col-12 d-flex align-items-center justify-content-between">
      <div>
        <!-- dropdown to switch batches -->
        <br>
        <h1 class="page-title mb-0">Members</h1>
        <div class="d-flex align-items-center gap-3">
          <select id="batchSelect" class="form-control" style="min-width:160px;">
            {% for b in batches %}
              <option value="{{ b.id }}" {% if b.id == selected_batch_id %}selected{% endif %}>Batch {{ b.number }}</option>
            {% endfor %}
          </select>
          
        </div>
        <p class="text-muted mb-0">Members: {{ total_members }}</p>
      </div>

      <div class="d-flex gap-2">
        <input id="batchSearch" class="form-control" placeholder="Search member or plate..." value="{{ q }}" style="min-width:260px;" />
        <select id="batchFilter" class="form-control">
          <option value="">All</option>
          <option value="urgent" {% if status_filter == 'urgent' %}selected{% endif %}>Urgent (0–15d)</option>
          <option value="upcoming" {% if status_filter == 'upcoming' %}selected{% endif %}>Upcoming (30–60d)</option>
          <option value="normal" {% if status_filter == 'normal' %}selected{% endif %}>Normal</option>
        </select>
        <a href="{% url 'home' %}" class="btn btn-outline-secondary">Back</a>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card admin-card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Member</th>
                  <th>Vehicle / Plate</th>
                  <th>Latest Renewal (per vehicle)</th>
                  <th>Days Left</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="batchMembersBody">
                {% include 'includes/batch_member_rows.html' %}
              </tbody>
            </table>
          </div>

          <div id="batchPagination" class="mt-3">
            {% include 'includes/pagination.html' %}
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
(function(){
  var $input = $('#batchSearch');
  var $filter = $('#batchFilter');
  var $body = $('#batchMembersBody');
  var $pagination = $('#batchPagination');
  var $batchSelect = $('#batchSelect');
  var timer = null;

  function fetch(page) {
    page = page || 1;
    var q = $input.val();
    var status = $filter.val();
    var url = window.location.pathname;
    $.ajax({
      url: url,
      data: { q: q, status: status, page: page },
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      dataType: 'json',
      success: function(res){
        if (res && res.html !== undefined) {
          $body.html(res.html);
          if (res.pagination !== undefined) $pagination.html(res.pagination);
          // re-bind pagination link handlers
          bindPagination();
        }
      }
    });
  }

  function bindPagination() {
    $pagination.find('.batch-page-link').off('click').on('click', function(e){
      e.preventDefault();
      var p = $(this).data('page');
      if (!p) return;
      fetch(p);
    });
  }

  $input.on('input', function(){
    clearTimeout(timer);
    timer = setTimeout(function(){ fetch(1); }, 300);
  });

  $filter.on('change', function(){ fetch(1); });

  $batchSelect.on('change', function(){
    var id = $(this).val();
    if (!id) return;
    window.location.href = '/batches/' + id + '/';
  });

  // initial binding for pagination links rendered server-side
  bindPagination();

  // allow external trigger
  $(document).on('batchDetail:refresh', function(){ fetch(1); });
})();
</script>
{% endblock %}