{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_all.css' %}">
{% endblock %}

{% block title %}Batch {{ batch.number }} — Members{% endblock %}

{% block content %}
<div class="admin-dashboard container py-5">
  <!-- Header: back button + batch dropdown -->
   <br>
  <div class="members-header card-header-gradient mb-4 d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between">
    <div class="d-flex align-items-center w-100">
      <a href="{% url 'member_list' %}" class="back-btn mr-3" title="Back to Members">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
          <path d="M15 18l-6-6 6-6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
      <div>
        <h1 class="members-header-title mb-1">MEMBERS — BATCH {{ batch.number }}</h1>
      </div>
    </div>

    <div class="d-flex flex-column flex-md-row align-items-stretch align-items-md-center mt-3 mt-md-0">
      <div class="mr-md-3" style="min-width:180px;">
        <select id="batchSelect" class="form-control">
          {% for b in batches %}
            <option value="{{ b.id }}" {% if b.id == selected_batch_id %}selected{% endif %}>BATCH {{ b.number }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <!-- Search and filter (two separate boxes) -->
  <div class="d-flex flex-column flex-md-row align-items-stretch mb-3" style="gap: 12px;">
    <!-- Search box -->
    <form id="batch-search-form" class="w-100" action="" method="get" style="flex:1;">
      <div class="search-card p-2 d-flex align-items-center" style="width:100%;">
        <input id="batchSearch" name="q" class="form-control search-input" placeholder="Search member name..." value="{{ q }}" style="flex:1;" />
        <button type="button" id="batch-search-btn" class="btn btn-primary ml-2" title="Search">
          <i class="la la-search" aria-hidden="true"></i>
          <span class="sr-only">Search</span>
        </button>
      </div>
    </form>

    <!-- Filter dropdown -->
    <form id="batch-filter-form" class="w-100" action="" method="get" style="flex:1;">
      <div class="search-card p-2 d-flex align-items-center" style="width:100%;">
        <select id="batchFilter" name="status" class="form-control" style="flex:1;">
          <option value="">Filter by status</option>
          <option value="urgent" {% if status_filter == 'urgent' %}selected{% endif %}>Urgent (0–15d)</option>
          <option value="upcoming" {% if status_filter == 'upcoming' %}selected{% endif %}>Upcoming (30–60d)</option>
          <option value="normal" {% if status_filter == 'normal' %}selected{% endif %}>Normal</option>
        </select>
      </div>
    </form>
  </div>

  <!-- Card with table -->
  <div class="row">
    <div class="col-12">
      <div class="card admin-card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped batch-table">
              <thead>
                <tr>
                  <th>Member</th>
                  <th>Vehicle / Plate</th>
                  <th>Latest Renewal (per vehicle)</th>
                  <th>Days Left</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="batchMembersBody">
                {% include 'includes/batch_member_rows.html' %}
              </tbody>
            </table>
          </div>

          <div id="batchPagination" class="mt-3">
            {% include 'includes/pagination.html' %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
(function(){
  var $input = $('#batchSearch');
  var $filter = $('#batchFilter');
  var $body = $('#batchMembersBody');
  var $pagination = $('#batchPagination');
  var $batchSelect = $('#batchSelect');
  var timer = null;

  function fetch(page) {
    page = page || 1;
    var q = $input.val();
    var status = $filter.val();
    var url = window.location.pathname;
    $.ajax({
      url: url,
      data: { q: q, status: status, page: page },
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      dataType: 'json',
      success: function(res){
        if (res && res.html !== undefined) {
          $body.html(res.html);
          if (res.pagination !== undefined) $pagination.html(res.pagination);
          bindPagination();
        }
      }
    });
  }

  function bindPagination() {
    $pagination.find('.batch-page-link').off('click').on('click', function(e){
      e.preventDefault();
      var p = $(this).data('page');
      if (!p) return;
      fetch(p);
    });
  }

  $input.on('input', function(){
    clearTimeout(timer);
    timer = setTimeout(function(){ fetch(1); }, 300);
  });

  $filter.on('change', function(){ fetch(1); });

  // bind the new search button to trigger the same fetch behaviour
  $('#batch-search-btn').on('click', function(){ fetch(1); });

  $batchSelect.on('change', function(){
    var id = $(this).val();
    if (!id) return;
    window.location.href = '/batches/' + id + '/';
  });

  bindPagination();
})();
</script>
{% endblock %}