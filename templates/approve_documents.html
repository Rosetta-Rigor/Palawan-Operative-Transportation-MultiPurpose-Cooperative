{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_all.css' %}">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block title %}Pending User Uploads{% endblock %}
{% block content %}
<br><br>
<div class="approve-docs-card">
  <div class="members-header card-header-gradient mb-4 d-flex justify-content-between align-items-center">
    <div>
      <h1 class="members-header-title">PENDING USER UPLOADS</h1>
      <p class="members-header-sub">Manager user document uploads</p>
    </div>
    <div class="d-flex align-items-center">
      <div class="btn-group">
        <a href="{% url 'document_list' %}" class="btn btn-success">View Documents</a>
      </div>
    </div>
  </div>

    <div class="search-card p-3 d-flex align-items-center">
        <select id="member-filter" style="width:320px;">
          <option value="">All members</option>
        </select>
    </div>

  <div class="approve-table">
    <table class="table mb-0">
      <thead>
        <tr>
          <th>Document (TIN)</th>
          <th>Vehicle</th>
          <th>Member</th>
          <th>Uploaded By</th>
          <th>Upload Date</th>
          <th>Files</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="approve-table-body">
        {% include 'includes/approve_documents_rows.html' %}
      </tbody>
    </table>
  </div>

  <div id="pagination-container" class="mt-3">
    {% include 'includes/pagination.html' %}
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(function(){
  // select2 member search (remote)
  $('#member-filter').select2({
    placeholder: 'Search member by name...',
    allowClear: true,
    ajax: {
      url: "{% url 'member_search_api' %}",
      dataType: 'json',
      delay: 250,
      data: function(params){ return { q: params.term }; },
      processResults: function(data){ return { results: data.results || [] }; }
    },
    minimumInputLength: 1
  });

  // when member selected -> reload rows via AJAX (preserve pagination)
  $('#member-filter').on('change', function(){
    var member = $(this).val() || '';
    fetchEntries({ member: member, page: 1 });
  });

  // debounce
  function debounce(fn, delay){ var t; return function(){ var ctx=this,args=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(ctx,args); }, delay); }; }

  function fetchEntries(params){
    params = params || {};
    $.ajax({
      url: "{% url 'approve_documents' %}",
      data: params,
      dataType: 'json',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      success: function(data){
        if (data.html !== undefined) $('#approve-table-body').html(data.html);
        if (data.pagination_html !== undefined) $('#pagination-container').html(data.pagination_html);
      }
    });
  }

  // intercept pagination clicks in this area to do full page navigations or AJAX as desired
  $(document).off('click.approvePagination').on('click.approvePagination', '#pagination-container .pagination a.page-link', function(e){
    var href = $(this).attr('href') || '';
    if (!href) return;
    // allow full navigation to keep pagination consistent with other pages
    return;
  });

  // Single-form action switching (Approve / Reject)
  $(document).on('click', '.action-toggle-btn', function(e){
    var $btn = $(this);
    var mode = $btn.data('mode'); // 'approve' or 'reject'
    var $form = $btn.closest('form[data-approve-url]');
    if (!$form.length) return;
    if (mode === 'reject'){
      $form.find('.action-submit').removeClass('btn-approve').addClass('btn-reject').text('Reject');
      $form.data('mode','reject');
    } else {
      $form.find('.action-submit').removeClass('btn-reject').addClass('btn-approve').text('Approve');
      $form.data('mode','approve');
    }
  });

  // on submit, route to correct endpoint
  $(document).on('submit', 'form[data-approve-url]', function(e){
    var $form = $(this);
    var mode = $form.data('mode') || 'approve';
    var approveUrl = $form.data('approve-url');
    var rejectUrl = $form.data('reject-url');
    $form.attr('action', mode === 'reject' ? rejectUrl : approveUrl);
    // allow submit
  });
});
</script>
{% endblock %}
