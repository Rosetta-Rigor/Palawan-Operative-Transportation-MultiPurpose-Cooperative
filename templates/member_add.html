{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block content %}
<style>
label[for$="-DELETE"], input[name$="-DELETE"] {
    display: none !important;
}
</style>
<div class="content">
    <div class="container-fluid">
        <h4 class="page-title">{{ title|default:"Add Member" }}</h4>
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Member Information</div>
                    </div>
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            {% if form.non_field_errors %}
                              <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                            {% endif %}

                            <div class="form-group">
                                <label for="{{ form.full_name.id_for_label }}">Full Name</label>
                                {{ form.full_name|add_class:"form-control" }}
                                {% if form.full_name.errors %}<div class="text-danger small">{{ form.full_name.errors }}</div>{% endif %}
                            </div>

                            <div class="form-group">
                                <label for="{{ form.batch.id_for_label }}">Batch</label>
                                {{ form.batch|add_class:"form-control" }}
                                {% if form.batch.errors %}<div class="text-danger small">{{ form.batch.errors }}</div>{% endif %}
                            </div>

                            <div class="form-group">
                                <label for="{{ form.batch_monitoring_number.id_for_label }}">Batch Monitoring Number</label>
                                {{ form.batch_monitoring_number|add_class:"form-control" }}
                                {% if form.batch_monitoring_number.errors %}<div class="text-danger small">{{ form.batch_monitoring_number.errors }}</div>{% endif %}
                            </div>

                            {% if form.user_account %}
                            <div class="form-group">
                                <label for="userAccountSelect">User Account</label>
                                <select id="userAccountSelect" name="user_account" class="form-control" style="width:100%">
                                    {% if form.instance and form.instance.user_account %}
                                        <option value="{{ form.instance.user_account.id }}" selected>{{ form.instance.user_account.full_name|default:form.instance.user_account.username }}</option>
                                    {% endif %}
                                </select>
                                {% if form.user_account.errors %}<div class="text-danger small">{{ form.user_account.errors }}</div>{% endif %}
                            </div>
                            {% endif %}

                            <h5 class="mt-4">Vehicle Information (optional)</h5>
                            {{ formset.management_form }}
                            {% for vehicle_form in formset %}
                                <div class="card mb-2 p-3 bg-light">
                                    {% if vehicle_form.non_field_errors %}
                                      <div class="alert alert-danger">{{ vehicle_form.non_field_errors }}</div>
                                    {% endif %}
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="{{ vehicle_form.plate_number.id_for_label }}">Plate Number</label>
                                            {{ vehicle_form.plate_number|add_class:"form-control" }}
                                            {% if vehicle_form.plate_number.errors %}<div class="text-danger small">{{ vehicle_form.plate_number.errors }}</div>{% endif %}
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="{{ vehicle_form.engine_number.id_for_label }}">Engine Number</label>
                                            {{ vehicle_form.engine_number|add_class:"form-control" }}
                                            {% if vehicle_form.engine_number.errors %}<div class="text-danger small">{{ vehicle_form.engine_number.errors }}</div>{% endif %}
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="{{ vehicle_form.chassis_number.id_for_label }}">Chassis Number</label>
                                            {{ vehicle_form.chassis_number|add_class:"form-control" }}
                                            {% if vehicle_form.chassis_number.errors %}<div class="text-danger small">{{ vehicle_form.chassis_number.errors }}</div>{% endif %}
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="{{ vehicle_form.make_brand.id_for_label }}">Make/Brand</label>
                                            {{ vehicle_form.make_brand|add_class:"form-control" }}
                                            {% if vehicle_form.make_brand.errors %}<div class="text-danger small">{{ vehicle_form.make_brand.errors }}</div>{% endif %}
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-4">
                                            <label for="{{ vehicle_form.year_model.id_for_label }}">Year Model</label>
                                            {{ vehicle_form.year_model|add_class:"form-control" }}
                                            {% if vehicle_form.year_model.errors %}<div class="text-danger small">{{ vehicle_form.year_model.errors }}</div>{% endif %}
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="{{ vehicle_form.series.id_for_label }}">Series</label>
                                            {{ vehicle_form.series|add_class:"form-control" }}
                                            {% if vehicle_form.series.errors %}<div class="text-danger small">{{ vehicle_form.series.errors }}</div>{% endif %}
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="{{ vehicle_form.color.id_for_label }}">Color</label>
                                            {{ vehicle_form.color|add_class:"form-control" }}
                                            {% if vehicle_form.color.errors %}<div class="text-danger small">{{ vehicle_form.color.errors }}</div>{% endif %}
                                        </div>
                                    </div>
                                    {% if vehicle_form.can_delete %}
                                    <div class="form-check">
                                        {{ vehicle_form.DELETE }} <label class="form-check-label">Remove</label>
                                    </div>
                                    {% endif %}
                                </div>
                            {% endfor %}

                            <div class="mt-3">
                              <button type="submit" class="btn btn-primary">Save</button>
                              <a href="{% url 'member_list' %}" class="btn btn-secondary">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const $select = $('#userAccountSelect');
    console.log('member_add.js: found select length=', $select.length, 'select2 fn:', typeof $.fn.select2);
    if ($select.length && $.fn && $.fn.select2) {
        $select.select2({
            theme: 'bootstrap-5',
            placeholder: "-- Unselect User Account --",
            allowClear: true,
            ajax: {
                url: "{% url 'user_search_api' %}",
                dataType: 'json',
                delay: 250,
                data: function(params) { return { q: params.term }; },
                processResults: function(data) { return { results: data.results }; },
                cache: true
            },
            minimumInputLength: 1,
            width: 'resolve'
        })
        .on('select2:open', function() { console.log('member_add: select2 opened'); })
        .on('select2:select', function(e) { console.log('member_add: selected', e.params && e.params.data); });

        // Log keystrokes in the Select2 search input to ensure typing is captured
        $(document).on('keyup', '.select2-search__field', function(e) {
            console.log('member_add: search input value=', $(this).val());
        });

        // Capture AJAX errors for the search URL
        $(document).ajaxError(function(event, jqxhr, settings, thrownError) {
            try {
                var searchUrl = "{% url 'user_search_api' %}";
                if (settings && settings.url && settings.url.indexOf(searchUrl) !== -1) {
                    console.error('member_add: AJAX error calling user_search_api', jqxhr.status, thrownError, jqxhr.responseText);
                }
            } catch (err) { console.error('member_add: ajaxError handler failed', err); }
        });
    } else {
        console.warn('member_add: Select2 not available; inserting simple fallback input');
        // lightweight fallback so user can at least type something
        $('#userAccountSelect').replaceWith('<input type="text" id="userAccountFallback" name="user_account_text" class="form-control" placeholder="Type username or full name">');
    }
});
</script>
{% endblock %}
